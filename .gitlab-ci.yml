stages:
  - test
  - deploy

variables:
  DOCKER_DRIVER: overlay2

run_tests:
  stage: test
  image: remram/rust
  script:
    - set -e
    - make test

pages:
  stage: deploy
  image: remram/rust
  services:
    - docker:dind
  script:
    - set -e
    - apt-get update
    - apt-get install -y make git pkg-config libssl1.0-dev
    - curl -Lo /tmp/docker.tgz https://get.docker.com/builds/Linux/x86_64/docker-17.05.0-ce.tgz && tar -xf /tmp/docker.tgz -C /usr/local && rm /tmp/docker.tgz && export PATH=/usr/local/docker:$PATH && export DOCKER_HOST=tcp://docker:2375
    - make wasm
    - (cd webapp && ./docker.sh install && ./docker.sh build)
    - mkdir public && cp webapp/dist/* public/
  artifacts:
    paths:
      - public
